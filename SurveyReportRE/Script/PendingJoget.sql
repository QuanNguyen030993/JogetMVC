  SELECT qt.id AS 'id',  qt.c_reqDate AS 'DateCreatedQT', '' AS 'DateCreatedPM', qt.c_reqDate AS 'DateCreated', cn.c_branch AS 'BranchOffice',  qt.c_policyHolder AS 'Policyholder',  qt.c_qrNum AS 'RequestQuotationNumber',  qt.c_jogetQuoNum AS 'QuotationNumber',  qt.c_productName AS 'ProductType', qt.c_policyNo AS 'PolicyNumber', cn.c_businessOccupationEng AS 'BusinessOccupation', cn.c_clientType AS 'ClientType', qt.c_businessChannel AS 'BusinessChannel', qt.c_reqType AS 'RequestType', qt.c_foUname AS 'MKTFORequestedQuotationBy', qt.c_mktTs AS 'MKTTS', qt.c_mgrUname AS 'MKTManager', qt.c_typeOfReferral AS 'Referraltype', qt.c_mgrTs AS 'DateofQuotationsignedbyMKTauthority', qt.c_qtStatusLabel AS 'Status', qt.c_attQuo AS 'QuotationType', ss.username AS 'FirstUWthatAcceptedRisk', endTsTask.dateEnd As 'FirstdateofUWApprove', '' AS 'PM', '' AS 'PolicyIssuanceRequestNumber',  '' AS 'PolicyIssuanceRequestNumberTS',  qt.c_refNum AS 'ReferenceNumber', qt.c_attQuo AS 'attQuo', qt.c_location AS 'location', CASE     WHEN qt.c_attachResForm = 'Yes' THEN qt.c_reqResNo     WHEN qt.c_attachResForm = 'No' THEN res.c_reqResNo     ELSE '' END AS 'RESNumber', 'qt' AS 'table', qt.c_dateTSAccept AS 'dateTSAccept', qt.c_mgrTs AS 'mgrTs', qt.c_dateFOComplete AS 'dateFOComplete', '' AS 'acceptedDate', '' AS 'completedDate', '' AS 'dateTSSubmitted', qt.c_numOfQuot AS 'numOfQuot', '' as 'numOfPolicy' INTO #Tmp_Result FROM app_fd_tmiv_qp_m_qt qt  LEFT JOIN app_fd_tmiv_qp_s_clientName cn ON cn.id = qt.c_policyHolder LEFT JOIN app_fd_tmiv_qp_m_res res ON res.id = qt.id LEFT JOIN (SELECT at.c_parentId, MIN(at.c_dateEnd) AS 'dateAcceptTask', MIN(at.c_username) AS 'username'       FROM app_fd_tmiv_qp_m_at at WHERE at.c_status ='UW Risk Accepted'   GROUP BY at.c_parentId ) ss ON ss.c_parentId = qt.id  LEFT JOIN (SELECT at.c_parentId, MIN(at.c_dateEnd) AS 'dateEnd'     FROM app_fd_tmiv_qp_m_at at  LEFT JOIN  app_fd_tmiv_qp_m_qt f ON f.id = at.c_parentId WHERE at.c_status ='UW''s Decision' AND f.c_typeOfReferral != 'UW On Processing'  GROUP BY at.c_parentId ) endTsTask ON endTsTask.c_parentId = qt.id  UNION ALL SELECT  pm.id AS 'id',  '' AS 'DateCreatedQT', pip.c_reqDate AS 'DateCreatedPM', pip.c_reqDate AS 'DateCreated', cb.c_branch AS 'BranchOffice',  pm.c_policyHolder AS 'Policyholder',  '' AS 'Request Quotation Number',  pm.c_jogetQuoNum AS 'QuotationNumber',  pm.c_productName AS 'ProductType', pm.c_policyNo AS 'PolicyNumber', cb.c_businessOccupationEng AS 'BusinessOccupation', cb.c_clientType AS 'ClientType', pm.c_businessChannel AS 'BusinessChannel', pm.c_reqType AS 'RequestType', pm.c_FOIncharged AS 'MKTFORequestedQuotationBy', pm.c_TSIncharged AS 'MKTTS', '' AS 'MKTManager', '' AS 'Referraltype', '' AS 'DateofQuotationsignedbyMKTauthority', pm.c_piStatusLabel AS 'Status', '' AS 'QuotationType', '' AS 'FirstUWthatAcceptedRisk', '' As 'FirstdateofUWApprove', pm.c_PMPIC AS 'PM', pip.c_piNumByFo AS 'PolicyIssuanceRequestNumber',  pip.c_piNumByTs AS 'PolicyIssuanceRequestNumberTS',  pm.c_piRefNum AS 'ReferenceNumber', '' AS 'attQuo', '' AS 'location', '' AS 'RESNumber', 'pm' AS 'table', '' AS 'dateTSAccept', '' AS 'mgrTs', '' AS 'dateFOComplete', pm.c_acceptedDate AS 'acceptedDate', pm.c_completedDate AS 'completedDate', '' AS 'dateTSSubmitted', '' AS 'numOfQuot', pm.c_numOfPolicy as 'numOfPolicy' FROM app_fd_tmiv_qp_m_pi pip LEFT JOIN app_fd_tmiv_qp_s_clientName cb ON cb.id = pip.c_policyHolder RIGHT JOIN app_fd_tmiv_qp_m_pm pm ON pm.c_parent_id = pip.id  UNION ALL SELECT  pip.id AS 'id',  '' AS 'DateCreatedQT', pip.c_reqDate AS 'DateCreatedPM', pip.c_reqDate AS 'DateCreated', cb.c_branch AS 'BranchOffice',  pip.c_policyHolder AS 'Policyholder',  '' AS 'Request Quotation Number',  pip.c_jogetQuoNum AS 'QuotationNumber',  pip.c_productName AS 'ProductType', pip.c_policyNo AS 'PolicyNumber', cb.c_businessOccupationEng AS 'BusinessOccupation', cb.c_clientType AS 'ClientType', pip.c_businessChannel AS 'BusinessChannel', pip.c_reqType AS 'RequestType', pip.c_FOIncharged AS 'MKTFORequestedQuotationBy', pip.c_TSIncharged AS 'MKTTS', '' AS 'MKTManager', '' AS 'Referraltype', '' AS 'DateofQuotationsignedbyMKTauthority', pip.c_piStatusLabel AS 'Status', '' AS 'QuotationType', '' AS 'FirstUWthatAcceptedRisk', '' As 'FirstdateofUWApprove', '' AS 'PM', pip.c_piNumByFo AS 'PolicyIssuanceRequestNumber',  pip.c_piNumByTs AS 'PolicyIssuanceRequestNumberTS',  pip.c_piRefNum AS 'ReferenceNumber', '' AS 'attQuo', '' AS 'location', '' AS 'RESNumber', 'pi' AS 'table', '' AS 'dateTSAccept', '' AS 'mgrTs', '' AS 'dateFOComplete', '' AS 'acceptedDate', '' AS 'completedDate', pip.c_dateFOTS AS 'dateTSSubmitted', '' AS 'numOfQuot', '' as 'numOfPolicy' FROM app_fd_tmiv_qp_m_pi pip LEFT JOIN app_fd_tmiv_qp_s_clientName cb ON cb.id = pip.c_policyHolder WHERE pip.c_piStatusLabel IN ('New', 'Prepare Policy Issuance', 'Return to MKTFO', 'Re-assign(TS)', 'Resubmitted') AND (pip.c_reqType <> 'PM')   SELECT *  INTO #Tmp_Complete FROM app_fd_tmiv_qp_m_qt qt WHERE (qt.c_qtStatus = '21' OR qt.c_qtStatus = '61')   SELECT  pip.id AS 'id',  pip.dateCreated AS 'dateCreated', pip.createdBy AS 'createdBy', pip.c_piNumByFo AS 'piNum',  pip.c_piNumByTs AS 'piNumTs',  '' AS 'piNumPm',  pip.c_reqDate AS 'reqDate',  '' AS 'dueDate',  pip.c_reqType AS 'reqType',  pip.c_policyNo AS 'policyNo',  pip.c_piType AS 'piType',  pip.c_policyHolder AS 'policyHolder',  pip.c_reqPerson AS 'reqPerson', pip.c_jogetQuoNum AS 'jogetQuoNum',  statusTable.c_listing AS 'piStatus',  pip.c_preRemark AS 'Remarks', 'PI' AS 'from', '' AS 'productType', '' AS 'completedDate', '' AS 'businessChannel', '' AS 'nameOfBizChannel', pip.c_sourceOfBusiness AS 'sourceOfBusiness', ''  AS 'periodInsStart', '' AS 'piRefNum', '' AS 'PM', '' AS 'dateFOTS', '' AS 'TS' INTO #Tmp_CompletePI FROM app_fd_tmiv_qp_m_pi pip JOIN (SELECT id, c_listing, 'pi' AS 'statusTable' FROM app_fd_tmiv_qp_s_piStatus) statusTable ON statusTable.id = pip.c_piStatus LEFT JOIN app_fd_tmiv_qp_m_pm pm ON pm.c_parent_id = pip.id  WHERE (pm.c_piStatus = '' OR pm.c_piStatus IS NULL) AND 1=2 UNION ALL SELECT  pm.id AS 'id',  pip.dateCreated AS 'dateCreated', pip.createdBy AS 'createdBy', pip.c_piNumByFo AS 'piNum',  pip.c_piNumByTs AS 'piNumTs',  pm.c_piNumByPm AS 'piNumPm',  pip.c_reqDate AS 'reqDate',  pm.c_dueDate AS 'dueDate',  pm.c_reqType AS 'reqType',  pm.c_policyNo AS 'policyNo',  pip.c_piType AS 'piType',  pip.c_policyHolder AS 'policyHolder',  pm.c_FOIncharged AS 'reqPerson', pm.c_jogetQuoNum AS 'jogetQuoNum',  statusTable.c_listing AS 'piStatus',  pm.c_preRemark AS 'Remarks', 'PM' AS 'from', pm.c_productName AS 'productType', pm.c_completedDate AS 'completedDate', pm.c_businessChannel AS 'businessChannel', pm.c_nameOfBizChannel AS 'nameOfBizChannel', pip.c_sourceOfBusiness AS 'sourceOfBusiness', qt.c_periodInsStart  AS 'periodInsStart', pm.c_piRefNum AS 'piRefNum', pm.c_PMPIC AS 'PM', pm.c_dateFOTS AS 'dateFOTS', pm.c_TSIncharged AS 'TS' FROM app_fd_tmiv_qp_m_pm pm LEFT JOIN app_fd_tmiv_qp_m_pi pip ON pip.id = pm.c_parent_id  JOIN (SELECT id, c_listing, 'pm' AS 'statusTable' FROM app_fd_tmiv_qp_s_pmStatus) statusTable ON statusTable.id = pm.c_piStatus LEFT JOIN app_fd_tmiv_qp_m_qt qt ON qt.id = pm.c_jogetQuoNum WHERE pm.c_pmStatus IN ('41','42','43','44','51','52','53','54','55','56','57','61','62','63')   SELECT  CASE WHEN c.c_jogetQuoNum IS NULL THEN 'No'                 ELSE 'Yes' END AS CompleteQuo, 				t.* 				INTO #Tmp_Final FROM #Tmp_Result t LEFT JOIN #Tmp_Complete c ON c.c_jogetQuoNum = t.QuotationNumber    SELECT DISTINCT policyHolder , completedDate INTO #Tmp_ComPIHolderDate FROM #Tmp_CompletePI    SELECT  f.id,SHKActivities.Name AS 'NextActionOnJoget', SHKAssignmentsTable.ResourceId AS 'NextPerson',[Status] AS 'ActionDoneQuotationStatus' , f.MKTFORequestedQuotationBy ,f.MKTTS ,f.FirstUWthatAcceptedRisk ,f.PM ,f.QuotationNumber ,f.CompleteQuo ,f.DateCreatedQT ,f.DateCreatedPM ,f.DateCreated ,f.BranchOffice ,f.RequestQuotationNumber ,f.PolicyNumber ,f.ClientType ,f.RequestType ,f.MKTManager ,f.Referraltype ,f.DateofQuotationsignedbyMKTauthority ,f.QuotationType ,f.FirstdateofUWApprove INTO #Tmp_Core FROM #Tmp_Final f  INNER JOIN SHKProcessData ON f.id = SHKProcessData.VariableValueVCHAR  INNER JOIN SHKProcesses ON SHKProcessData.Process = SHKProcesses.oid  INNER JOIN SHKActivities ON SHKActivities.ProcessId = SHKProcesses.Id  INNER JOIN SHKAssignmentsTable ON  SHKAssignmentsTable.ActivityId = SHKActivities.Id WHERE CompleteQuo = 'No'   SELECT  f.id,c.[NextActionOnJoget],c.[NextPerson],c.[ActionDoneQuotationStatus], f.MKTFORequestedQuotationBy ,f.MKTTS ,f.FirstUWthatAcceptedRisk ,f.PM ,f.QuotationNumber ,f.CompleteQuo ,f.DateCreatedQT ,f.DateCreatedPM ,f.DateCreated ,f.BranchOffice ,f.RequestQuotationNumber ,f.PolicyNumber ,f.ClientType ,f.RequestType ,f.MKTManager ,f.Referraltype ,f.DateofQuotationsignedbyMKTauthority ,f.QuotationType ,f.FirstdateofUWApprove FROM #Tmp_Final f  LEFT JOIN  #Tmp_Core c ON  c.id = f.id WHERE NextPerson <> ''